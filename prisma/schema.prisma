generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// CORE MODELS YOUR TS CODE REFERENCES
//

model Workspace {
  id                     String    @id @default(cuid())
  name                   String?
  slug                   String?
  ownerId                String?
  plan                   String?
  agentLimit             Int?      @default(5)
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // relations
  workflows              Workflow[]
  agents                 Agent[]
  metrics                Metric[]
  members                MetricMember[]
  agentTasks             AgentTask[]
  workflowRuns           WorkflowRun[]
  billingEvents          BillingEvent[]
}

model Workflow {
  id          String    @id @default(cuid())
  workspaceId String
  name        String?
  description String?
  triggerType String?
  active      Boolean   @default(true)
  n8nWorkflowId String?
  config      Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  metrics     Metric[]
  runs        WorkflowRun[]
}

model Agent {
  id                     String    @id @default(cuid())
  workspaceId            String
  name                   String?
  type                   String?
  description            String?
  active                 Boolean   @default(true)
  confidenceScore        Float?
  configVaultId          String?
  stripeSubscriptionId   String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  metrics     Metric[]
  tasks       AgentTask[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  admin     Boolean  @default(false)
  createdAt DateTime @default(now())

  metrics   Metric[]
  memberships MetricMember[]
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())

  metrics   Metric[]
  logs      AdminLog[]
}

//
// THE BIG ONE: Metric
// make it a "catch-all" table since a lot of TS code was rewritten to use it
//

model Metric {
  id                    String    @id @default(cuid())
  workspaceId           String
  workflowId            String?
  agentId               String?
  adminId               String?
  userId                String?
  name                  String?
  plan                  String?
  status                String?     // 'running' | 'completed' | 'failed'
  eventType             String?
  amount                Float?
  costUsd               Float?
  durationMs            Int?
  value                 Float?
  output                Json?
  error                 String?
  input                 Json?
  action                String?
  taskType              String?
  targetId              String?
  date                  DateTime?
  runsToday             Int?
  spendToday            Float?
  activeAgents          Int?
  successRate           Float?
  completedAt           DateTime?
  stripeEventId         String?
  calculatedAt          DateTime?
  startedAt             DateTime?   @default(now())
  createdAt             DateTime?   @default(now())
  updatedAt             DateTime?   @updatedAt
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  slug                  String?
  currency              String?
  metadata              Json?
  details               Json?
  ownerId               String?

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  workflow   Workflow?  @relation(fields: [workflowId], references: [id])
  agent      Agent?     @relation(fields: [agentId], references: [id])
  admin      Admin?     @relation(fields: [adminId], references: [id])
  user       User?      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@index([date])
  @@unique([workspaceId, date])
}

//
// SUPPORTING MODELS THAT SHOWED UP IN ERRORS
//

model MetricMember {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  profileId   String?
  role        String?
  createdAt   DateTime  @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
}

model AgentTask {
  id          String    @id @default(cuid())
  agentId     String
  workspaceId String
  taskType    String?
  input       Json?
  status      String?
  createdAt   DateTime  @default(now())

  agent       Agent     @relation(fields: [agentId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
}

model WorkflowRun {
  id          String    @id @default(cuid())
  workflowId  String
  workspaceId String
  status      String?
  error       String?
  startedAt   DateTime?
  createdAt   DateTime  @default(now())

  workflow    Workflow  @relation(fields: [workflowId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
}

model BillingEvent {
  id            String    @id @default(cuid())
  workspaceId   String?
  eventType     String?
  amount        Float?
  currency      String?
  status        String?
  stripeEventId String?
  metadata      Json?
  createdAt     DateTime  @default(now())

  workspace     Workspace? @relation(fields: [workspaceId], references: [id])
}

model AdminLog {
  id        String   @id @default(cuid())
  adminId   String?
  action    String?
  targetId String?
  details   Json?
  createdAt DateTime @default(now())
  
  admin     Admin?   @relation(fields: [adminId], references: [id])
}

//
// models your routes touched
//

model BetLedger {
  id              String    @id @default(cuid())
  amount          Float?
  description     String?
  hypothesis      String?
  status          String?
  expectedImpact  String?
  confidenceScore Float?
  dateStarted     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ProfitNode {
  id        String   @id @default(cuid())
  name      String?
  createdAt DateTime @default(now())
}

model ProfitEdge {
  id        String   @id @default(cuid())
  fromId    String?
  toId      String?
  createdAt DateTime @default(now())
}
