generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workspace {
  id          String      @id @default(cuid())
  name        String
  plan        String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  workflows   Workflow[]
  agents      Agent[]
  metrics     Metric[]
  billing     BillingEvent[]
  users       User[]
  tasks       AgentTask[]
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  role         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  workspaceId  String?
  workspace    Workspace? @relation(fields: [workspaceId], references: [id])
}

model Workflow {
  id              String    @id @default(cuid())
  name            String
  description     String
  status          String    @default("idle")
  triggerType     String?
  config          Json?
  active          Boolean   @default(true)

  workspaceId     String
  workspace       Workspace @relation(fields: [workspaceId], references: [id])

  metrics         Metric[]
  runs            WorkflowRun[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model WorkflowRun {
  id          String   @id @default(cuid())
  workflowId  String
  status      String?
  startedAt   DateTime?
  finishedAt  DateTime?
  durationMs  Int?
  costUsd     Float?

  workflow    Workflow @relation(fields: [workflowId], references: [id])
}

model Metric {
  id              String     @id @default(cuid())
  name            String
  value           Float      @default(0)
  status          String?    // running | completed | failed
  costUsd         Float?
  durationMs      Int?
  runsToday       Int?       @default(0)

  workflowId      String?
  workflow        Workflow?  @relation(fields: [workflowId], references: [id])

  workspaceId     String?
  workspace       Workspace? @relation(fields: [workspaceId], references: [id])

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Agent {
  id                   String     @id @default(cuid())
  name                 String
  description          String
  type                 String
  active               Boolean    @default(true)
  configVaultId        String?
  confidenceScore      Float?
  stripeSubscriptionId String?

  workspaceId          String?
  workspace            Workspace? @relation(fields: [workspaceId], references: [id])

  tasks                AgentTask[]
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

model AgentTask {
  id          String     @id @default(cuid())
  input       Json?
  output      Json?
  status      String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  agentId     String?
  agent       Agent?     @relation(fields: [agentId], references: [id])

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])
}

model BillingEvent {
  id           String    @id @default(cuid())
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id])
  amountUsd    Float
  type         String
  createdAt    DateTime  @default(now())
}

model AdminLog {
  id          String   @id @default(cuid())
  adminId     String?
  workspaceId String?
  targetId    String?
  action      String
  createdAt   DateTime @default(now())
}

model ProfitNode {
  id            String       @id @default(cuid())
  name          String
  category      String?
  baselineValue Float?
  currentValue  Float?
  impactWeight  Float?
  createdAt     DateTime     @default(now())

  edgesFrom     ProfitEdge[] @relation("EdgesFrom")
  edgesTo       ProfitEdge[] @relation("EdgesTo")
}

model ProfitEdge {
  id          String    @id @default(cuid())
  fromNodeId  String?
  toNodeId    String?
  weight      Float?
  rationale   String?
  createdAt   DateTime  @default(now())

  fromNode    ProfitNode? @relation("EdgesFrom", fields: [fromNodeId], references: [id])
  toNode      ProfitNode? @relation("EdgesTo", fields: [toNodeId], references: [id])
}
